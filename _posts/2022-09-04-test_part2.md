---
title: "[Test] part.2 Jest"
date: 2022-09-04 21:00:00 +/0900
categories: [Test]
tags: [Test, Jest]
---

<p>
    테스트 피라미드 3단계의 가장 밑바탕이되는 unit test를 먼저 시작한다.
</p>

## Jest

- 자바스크립트에서 주로 사용되는 테스트 라이브러리이다.
- create-react-app으로 react 프로젝트를 생성시 함께 설치되는 라이브러리이기 때문에 React 환경의 테스트를 앞서서 vailla javascript를 Jest로 테스트한다.

### Jest 환경설정

1. Jest는 javascript 환경에서 사용해야하기 때문에 node js을 사용할 수 있도록 npm 환경을 설정한다.

   ```
   npm init --yes
   ```

   npm 환경설정이 완료되면 package.json파일이 생성되고

2. Jest 를 설치한다.

   ```
   npm install jest --global
   ```

3. jest 시작 + jest.config.js 파일 설치

   ```
   jest --init
   ```

   [jest.config.js 관련 정보](https://jestjs.io/docs/configuration)

4. jest 함수의 사용법을 쉽게 파악하기 위해 jest 타입을 설치한다. jest타입을 설치하면 package.json에 @types/jest dependency가 설치되고 jest관련 함수를 사용하고 ctrl + click(cursor)를 누르면 사용법을 확인할 수 있다.

   ```
   npm install @types/jest
   ```

5. package.json에 jest script 추가

   ```
   "scripts": {
       "test": "jest",
       "clear_jest": "jest --clearCache"
   },
   ```

   <code>npm run test</code> 로 jest를 실행, <code>npm run clear_jest</code>로 기존의 jest 수행결과 cache를 삭제한다.

### 함수 테스트

함수 테스트를 위해 mock을 사용한다.
mock은 함수를 태스트하기 위해 가짜(mock)으로 함수를 대체하는 기법을 말한다.
일반적으로 테스트하려는 코드가 의존하는 부분을 직접 생성하기가 부담스러운 경우 mocking이 사용된다.

#### check.js

```javascript
function check(predicate, onSuccess, onFail) {
  if (validate()) {
    onSuccess("yes");
  } else {
    onFail("no");
  }
}

module.exports = check;
```

<p>
 함수를 정의하고 테스트하기 위해 export 설정을 한다.
</p>

#### check.test.js

check.js 테스트하기위해 먼저 check.js를 import한다.

```javascript
const check = require("../check");
```

한 함수에서 다양한 상황을 테스트하기 위해 describe로 묶는다. 모든 테스트는 'check'라는 이름으로 묶인다.

```javascript
describe("check", () => {
    ...
});
```

describe내부에서 각 테스트별로 테스트 시작전에 공통적으로 불리는 코드는 beforeEach()로 묶어서 재사용성을 높인다.<br/>
it 혹은 test로 테스트할 상황을 정의하고 첫번째 인자로 상황을 정의하는 문장을 , 두번째 인자는 테스트 코드 함수를 받는다.

```javascript
describe("check", () => {
  let onSuccess;
  let onFail;

  beforeEach(() => {
    onSuccess = jest.fn();
    onFail = jest.fn();
  });


  it("should call onSuccess when validate is true", () => {
    ...
  });

  it("should call onFail when validate is false", () => {
    ...
  });
});
```

<p>
    각 테스트 별로 함수를 부르고 expect를 통해 기대하는 결과를 작성한다.<br/>
    테스트 별로 기대하는 결과는 expect 함수의 matcher<https://jestjs.io/docs/using-matchers>로 예상한 결과를 입력한다.
</p>

```javascript
//it 혹은 test로 테스트할 상황을 정의하고 첫번째 인자로 상황을 정의하는 문장을 , 두번째 인자는 테스트 코드 함수를 받는다.
it("should call onSuccess when validate is true", () => {
  check(() => true, onSuccess, onFail);

  //expect(onSuccess.mock.calls.length).toBe(1);
  expect(onSuccess).toHaveBeenCalledTimes(1);

  //expect(onSuccess.mock.calls[0][0]).toBe('yes');
  expect(onSuccess).toHaveBeenCalledWith("yes");

  //expect(onFail.mock.calls.length).toBe(0);
  expect(onFail).toHaveBeenCalledTimes(0);
});

it("should call onFail when validate is false", () => {
  check(() => false, onSuccess, onFail);

  //expect(onFail.mock.calls.length).toBe(1);
  expect(onFail).toHaveBeenCalledTimes(1);

  //expect(onFail.mock.calls[0][0]).toBe('no');
  expect(onFail).toHaveBeenCalledWith("no");

  //expect(onSuccess.mock.calls.length).toBe(0);
  expect(onSuccess).toHaveBeenCalledTimes(0);
});
```

### fail하도록 수정한 코드

![check.test.js의 validate 코드가 fail이 되도록 수정한 코드](/assets/img/check_test_validate_false.png)

### fail 결과 캡쳐화면

![check.test.js의 fail 결과 화면](/assets/img/check_test_fail.png)

<p>
    테스트에서 기대하는 결과가 나오지 않으면 fail과 함께 should call onSuccess when predicate is true테스트에서 틀렸다는 것을 확인할 수 있다.<br/>
    테스트 코드는 의도된 대로 작성되었지만 구현 코드가 잘못되어 실패했다면 테스트가 통과할 때까지 구현 코드를 수정한다.
</p>

💡참고

- [[Jest] jest.fn(), jest.spyOn() 함수 모킹](https://www.daleseo.com/jest-fn-spy-on/)
