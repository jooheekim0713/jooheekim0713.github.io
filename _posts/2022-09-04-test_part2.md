---
title: "[Test] part.2 Jest"
date: 2022-09-04 21:00:00 +/0900
categories: [Test]
tags: [Test, Jest]
---

<p>
    í…ŒìŠ¤íŠ¸ í”¼ë¼ë¯¸ë“œ 3ë‹¨ê³„ì˜ ê°€ì¥ ë°‘ë°”íƒ•ì´ë˜ëŠ” unit testë¥¼ ë¨¼ì € ì‹œì‘í•œë‹¤.
</p>

## Jest

- ìë°”ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ì£¼ë¡œ ì‚¬ìš©ë˜ëŠ” í…ŒìŠ¤íŠ¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ì´ë‹¤.
- create-react-appìœ¼ë¡œ react í”„ë¡œì íŠ¸ë¥¼ ìƒì„±ì‹œ í•¨ê»˜ ì„¤ì¹˜ë˜ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ì´ê¸° ë•Œë¬¸ì— React í™˜ê²½ì˜ í…ŒìŠ¤íŠ¸ë¥¼ ì•ì„œì„œ vailla javascriptë¥¼ Jestë¡œ í…ŒìŠ¤íŠ¸í•œë‹¤.

### Jest í™˜ê²½ì„¤ì •

1. JestëŠ” javascript í™˜ê²½ì—ì„œ ì‚¬ìš©í•´ì•¼í•˜ê¸° ë•Œë¬¸ì— node jsì„ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ npm í™˜ê²½ì„ ì„¤ì •í•œë‹¤.

   ```
   npm init --yes
   ```

   npm í™˜ê²½ì„¤ì •ì´ ì™„ë£Œë˜ë©´ package.jsoníŒŒì¼ì´ ìƒì„±ë˜ê³ 

2. Jest ë¥¼ ì„¤ì¹˜í•œë‹¤.

   ```
   npm install jest --global
   ```

3. jest ì‹œì‘ + jest.config.js íŒŒì¼ ì„¤ì¹˜

   ```
   jest --init
   ```

   [jest.config.js ê´€ë ¨ ì •ë³´](https://jestjs.io/docs/configuration)

4. jest í•¨ìˆ˜ì˜ ì‚¬ìš©ë²•ì„ ì‰½ê²Œ íŒŒì•…í•˜ê¸° ìœ„í•´ jest íƒ€ì…ì„ ì„¤ì¹˜í•œë‹¤. jestíƒ€ì…ì„ ì„¤ì¹˜í•˜ë©´ package.jsonì— @types/jest dependencyê°€ ì„¤ì¹˜ë˜ê³  jestê´€ë ¨ í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ê³  ctrl + click(cursor)ë¥¼ ëˆ„ë¥´ë©´ ì‚¬ìš©ë²•ì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

   ```
   npm install @types/jest
   ```

5. package.jsonì— jest script ì¶”ê°€

   ```
   "scripts": {
       "test": "jest",
       "clear_jest": "jest --clearCache"
   },
   ```

   <code>npm run test</code> ë¡œ jestë¥¼ ì‹¤í–‰, <code>npm run clear_jest</code>ë¡œ ê¸°ì¡´ì˜ jest ìˆ˜í–‰ê²°ê³¼ cacheë¥¼ ì‚­ì œí•œë‹¤.

## í•¨ìˆ˜ í…ŒìŠ¤íŠ¸

í•¨ìˆ˜ í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ [mock í•¨ìˆ˜](https://jestjs.io/docs/mock-function-api#mockfnmockimplementationfn)ì„ ì‚¬ìš©í•œë‹¤.

> Mock functions are also known as "spies", because they let you spy on the behavior of a function that is called indirectly by some other code, rather than only testing the output. You can create a mock function with jest.fn(). If no implementation is given, the mock function will return undefined when invoked.

mockì€ 'ìŠ¤íŒŒì´'ë¼ê³  ì•Œë ¤ì ¸ìˆë‹¤. mockì€ ê²°ê³¼ê°’ì„ í…ŒìŠ¤íŠ¸í•˜ëŠ”ê²Œ ì•„ë‹ˆë¼ ë‹¤ë¥¸ í•¨ìˆ˜ë¡œë¶€í„° ê°„ì ‘ì ìœ¼ë¡œ ë¶ˆë¦¬ëŠ” í•¨ìˆ˜ì˜ í–‰ë™ì„ ê°ì‹œí•œë‹¤.
<code>jest.fn()</code>ë¡œ mock í•¨ìˆ˜ë¥¼ ë§Œë“¤ ìˆ˜ ìˆê³  implement ê°€ ì—†ìœ¼ë©´ undefinedë¥¼ return í•œë‹¤.<br/>

mockì€ í•¨ìˆ˜ë¥¼ íƒœìŠ¤íŠ¸í•˜ê¸° ìœ„í•´ ê°€ì§œ(mock)ìœ¼ë¡œ í•¨ìˆ˜ë¥¼ ëŒ€ì²´í•˜ëŠ” ê¸°ë²•ì„ ë§í•œë‹¤.<br/>
ì¼ë°˜ì ìœ¼ë¡œ í…ŒìŠ¤íŠ¸í•˜ë ¤ëŠ” ì½”ë“œê°€ ì˜ì¡´í•˜ëŠ” ë¶€ë¶„ì„ ì§ì ‘ ìƒì„±í•˜ê¸°ê°€ ë¶€ë‹´ìŠ¤ëŸ¬ìš´ ê²½ìš° mockingì´ ì‚¬ìš©ëœë‹¤.

### check.js

```javascript
function check(predicate, onSuccess, onFail) {
  if (validate()) {
    onSuccess("yes");
  } else {
    onFail("no");
  }
}

module.exports = check;
```

<p>
 í•¨ìˆ˜ë¥¼ ì •ì˜í•˜ê³  í…ŒìŠ¤íŠ¸í•˜ê¸° ìœ„í•´ export ì„¤ì •ì„ í•œë‹¤.
</p>

### check.test.js

check.js í…ŒìŠ¤íŠ¸í•˜ê¸°ìœ„í•´ ë¨¼ì € check.jsë¥¼ importí•œë‹¤.

```javascript
const check = require("../check");
```

í•œ í•¨ìˆ˜ì—ì„œ ë‹¤ì–‘í•œ ìƒí™©ì„ í…ŒìŠ¤íŠ¸í•˜ê¸° ìœ„í•´ describeë¡œ ë¬¶ëŠ”ë‹¤. ëª¨ë“  í…ŒìŠ¤íŠ¸ëŠ” 'check'ë¼ëŠ” ì´ë¦„ìœ¼ë¡œ ë¬¶ì¸ë‹¤.

```javascript
describe("check", () => {
    ...
});
```

describeë‚´ë¶€ì—ì„œ ê° í…ŒìŠ¤íŠ¸ë³„ë¡œ í…ŒìŠ¤íŠ¸ ì‹œì‘ì „ì— ê³µí†µì ìœ¼ë¡œ ë¶ˆë¦¬ëŠ” ì½”ë“œëŠ” [beforeEach()](https://jestjs.io/docs/setup-teardown)ë¡œ ë¬¶ì–´ì„œ ì¬ì‚¬ìš©ì„±ì„ ë†’ì¸ë‹¤.<br/>
it í˜¹ì€ testë¡œ í…ŒìŠ¤íŠ¸í•  ìƒí™©ì„ ì •ì˜í•˜ê³  ì²«ë²ˆì§¸ ì¸ìë¡œ ìƒí™©ì„ ì •ì˜í•˜ëŠ” ë¬¸ì¥ì„ , ë‘ë²ˆì§¸ ì¸ìëŠ” í…ŒìŠ¤íŠ¸ ì½”ë“œ í•¨ìˆ˜ë¥¼ ë°›ëŠ”ë‹¤.

```javascript
describe("check", () => {
  let onSuccess;
  let onFail;

  beforeEach(() => {
    onSuccess = jest.fn();
    onFail = jest.fn();
  });


  it("should call onSuccess when validate is true", () => {
    ...
  });

  it("should call onFail when validate is false", () => {
    ...
  });
});
```

ê° í…ŒìŠ¤íŠ¸ ë³„ë¡œ checkí•¨ìˆ˜ë¥¼ ë¶€ë¥´ê³  expectë¥¼ í†µí•´ ê¸°ëŒ€í•˜ëŠ” ê²°ê³¼ë¥¼ ì‘ì„±í•œë‹¤.<br/>
í…ŒìŠ¤íŠ¸ ë³„ë¡œ ê¸°ëŒ€í•˜ëŠ” ê²°ê³¼ëŠ” [expect í•¨ìˆ˜ì˜ matcher](https://jestjs.io/docs/using-matchers)ë¥¼ ì‚¬ìš©í•´ í…ŒìŠ¤íŠ¸ì— ê¸°ëŒ€í•˜ëŠ” ê²°ê³¼ê°’ì„ ë¹„êµí•œë‹¤.

```javascript
//it í˜¹ì€ testë¡œ í…ŒìŠ¤íŠ¸í•  ìƒí™©ì„ ì •ì˜í•˜ê³  ì²«ë²ˆì§¸ ì¸ìë¡œ ìƒí™©ì„ ì •ì˜í•˜ëŠ” ë¬¸ì¥ì„ , ë‘ë²ˆì§¸ ì¸ìëŠ” í…ŒìŠ¤íŠ¸ ì½”ë“œ í•¨ìˆ˜ë¥¼ ë°›ëŠ”ë‹¤.
it("should call onSuccess when validate is true", () => {
  check(() => true, onSuccess, onFail);

  //expect(onSuccess.mock.calls.length).toBe(1);
  expect(onSuccess).toHaveBeenCalledTimes(1);

  //expect(onSuccess.mock.calls[0][0]).toBe('yes');
  expect(onSuccess).toHaveBeenCalledWith("yes");

  //expect(onFail.mock.calls.length).toBe(0);
  expect(onFail).toHaveBeenCalledTimes(0);
});

it("should call onFail when validate is false", () => {
  check(() => false, onSuccess, onFail);

  //expect(onFail.mock.calls.length).toBe(1);
  expect(onFail).toHaveBeenCalledTimes(1);

  //expect(onFail.mock.calls[0][0]).toBe('no');
  expect(onFail).toHaveBeenCalledWith("no");

  //expect(onSuccess.mock.calls.length).toBe(0);
  expect(onSuccess).toHaveBeenCalledTimes(0);
});
```

### failí•˜ë„ë¡ ìˆ˜ì •í•œ ì½”ë“œ

![check.test.jsì˜ validate ì½”ë“œê°€ failì´ ë˜ë„ë¡ ìˆ˜ì •í•œ ì½”ë“œ](/assets/img/check_test_validate_false.png)

### fail ê²°ê³¼ ìº¡ì³í™”ë©´

![check.test.jsì˜ fail ê²°ê³¼ í™”ë©´](/assets/img/check_test_fail.png)

<p>
    í…ŒìŠ¤íŠ¸ì—ì„œ ê¸°ëŒ€í•˜ëŠ” ê²°ê³¼ê°€ ë‚˜ì˜¤ì§€ ì•Šìœ¼ë©´ failê³¼ í•¨ê»˜ should call onSuccess when predicate is trueí…ŒìŠ¤íŠ¸ì—ì„œ í‹€ë ¸ë‹¤ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.<br/>
    í…ŒìŠ¤íŠ¸ ì½”ë“œëŠ” ì˜ë„ëœ ëŒ€ë¡œ ì‘ì„±ë˜ì—ˆì§€ë§Œ êµ¬í˜„ ì½”ë“œê°€ ì˜ëª»ë˜ì–´ ì‹¤íŒ¨í–ˆë‹¤ë©´ í…ŒìŠ¤íŠ¸ê°€ í†µê³¼í•  ë•Œê¹Œì§€ êµ¬í˜„ ì½”ë“œë¥¼ ìˆ˜ì •í•œë‹¤.
</p>

## í´ë˜ìŠ¤ í…ŒìŠ¤íŠ¸

### user_service.js

```javascript
class UserService {
  constructor(userClient) {
    this.userClient = userClient;
    this.isLogedIn = false;
  }

  login(id, password) {
    if (!this.isLogedIn) {
      return this.userClient
        .login(id, password)
        .then((data) => (this.isLogedIn = true));
    }
  }
}

module.exports = UserService;
```

ê¸°ì¡´ì˜ ì½”ë“œëŠ” user_service.js ë‚´ë¶€ì— fetch í•¨ìˆ˜ë¡œ ë°ì´í„°ë¥¼ ë°›ì•„ì™”ë‹¤.
í•˜ì§€ë§Œ ë„¤íŠ¸ì›Œí¬ì— ì˜ì¡´í•˜ëŠ” ì½”ë“œëŠ” mock ë˜ëŠ” stubìœ¼ë¡œ ë”°ë¡œ í…ŒìŠ¤íŠ¸ë¥¼ í•˜ê¸°ìœ„í•´ UserClientí´ë˜ìŠ¤ë¡œ ë¶„ë¦¬í•œë‹¤.
ê·¸ë¦¬ê³  UserService í´ë˜ìŠ¤ì—ì„œëŠ” userClientì— ë¶„ë¦¬ëœ í•¨ìˆ˜ê°€ ë„¤íŠ¸ì›Œí¬ì—°ê²°ë˜ì–´ ë°ì´í„°ë¥¼ ë°›ì•„ ì˜¬ ê²½ìš° login ìƒíƒœë¥¼ trueë¡œ ë³€ê²½í•œë‹¤.

### user_client.js

```javascript
class UserClient {
  login(id, password) {
    return fetch("http://example.com/login/id+password") //
      .then((response) => response.json());
  }
}

module.exports = UserClient;
```

UserClient í´ë˜ìŠ¤ ë‚´ë¶€ì— ë¹„ë™ê¸° loginí•¨ìˆ˜ë¥¼ ë§Œë“¤ê³  ë°ì´í„°ë¥¼ ë°›ì•„ì˜¨ë‹¤.

### user_service.test.js

```javascript
const UserService = require("../user_service");
const UserClient = require("../user_client");
jest.mock("../user_client");

describe("UserService", () => {
  const login = jest.fn(async () => "success");
  //UserClientì—ì„œ loginí•¨ìˆ˜ë¥¼ ë¶ˆëŸ¬ì˜¨ë‹¤.
  UserClient.mockImplementation(() => {
    return {
      login,
    };
  });

  let userService;

  beforeEach(() => {
    userService = new UserService(new UserClient());
    // login.mockClear();
    // UserClient.mockClear();
    //jest config clearMocks: true ì„¤ì •ì„ í•´ë†”ì„œ mockClearë¥¼ ì•ˆí•´ë„ ë¨
  });

  it("calls login on UserClient when tries to login", async () => {
    await userService.login("abc", "abc");
    expect(login).toHaveBeenCalledTimes(1);
  });

  it("should not call login() on UserClient again if already logged in", async () => {
    await userService.login("abc", "abc");
    await userService.login("abc", "abc");

    expect(login).toHaveBeenCalledTimes(1);
  });
});
```

```javascript
module.exports = {
  // All imported modules in your tests should be mocked automatically
  // automock: false,

  // Stop running tests after `n` failures
  // bail: 0,

  // The directory where Jest should store its cached dependency information
  // cacheDirectory: "C:\\Users\\jooheek\\AppData\\Local\\Temp\\jest",

  // ëª¨ë“  í…ŒìŠ¤íŠ¸ê°€ ì‹œì‘í•˜ê¸° ì „ì— mock call, instance, context, resultë¥¼ ëª¨ë‘ ë¦¬ì…‹í•´ì£¼ëŠ” ì„¤ì •ì´ë‹¤.
  clearMocks: true,

  // í…ŒìŠ¤íŠ¸ ê°€ ì–¼ë§ˆë‚˜ ì½”ë“œë¥¼ coverí•˜ëŠ”ì§€ ìˆ˜ì¹˜ë¥¼ ë³´ì—¬ì£¼ëŠ” ì„¤ì •ì´ë‹¤.
  collectCoverage: false,
};
```

jest.config.jsì—ì„œ í…ŒìŠ¤íŠ¸ ê°„ì˜ mockí•¨ìˆ˜ ë…ë¦½ì„±ì„ ìœ„í•´ clearMocks ì„¤ì •ì„ trueë¡œ, <br/>
í…ŒìŠ¤íŠ¸ ê²°ê³¼ë¥¼ ê°„ê²°í•˜ê²Œ ë³´ê¸° ìœ„í•´ <code>npm run test</code>í•˜ë©´ í•­ìƒ ë‚˜ì™”ë˜ í”„ë¡œì íŠ¸ ë‹¹ coverageë¥¼ falseë¡œ ì„¤ì •í•œë‹¤.

ğŸ’¡ì°¸ê³ 

- [[Jest] jest.fn(), jest.spyOn() í•¨ìˆ˜ ëª¨í‚¹](https://www.daleseo.com/jest-fn-spy-on/)
